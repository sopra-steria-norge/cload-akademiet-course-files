# Add authentication to your API (using Microsoft Authentication Library in Swagger) - HOW TO

## Starting branch
[ef-core](https://github.com/sopra-steria-norge/WhoOwesWhat-Net48/tree/ef-core)


What we are going to do in this part of the course:
- Add middleware in Program.cs (using Swashbuckle and config to set up Swagger)
- Add configuration & variables for identity in appsettings.json
- Decoration on controllers using the `[Authorize]` filter
- Application registration in Azure (we have already created this --> URL)

## TEST: Before we start doing changes, make sure that your WhoOwesWhat solution is built successfully and that the API returns 200 (OK)
- Build solution (F6) and launch app (F5)
- Try the endpoint `POST User/CreateUser` with some mock data of your choosing, should get a 200 (OK) response (since we're currently using an unprotected API)
- Make sure the `personGuid` is unique in the CreateUser request

![200 response](https://github.com/sopra-steria-norge/cloud-akademiet-course-files/blob/main/images/auth-images/200_ok_response_CreateUser.png)

## Add the neccessary NuGet packages to your project
- Add Nuget packages with `CLI`, `Package Manager` or right-click on solution and select `Manage NuGet Packages for Solution...`
- Required packages: `Swashbuckle.AspNetCore` (probably in your project already, install required only if not already there) & `Microsoft.Identity.Web`

![Swashbuckle.AspNetCore](https://github.com/sopra-steria-norge/cloud-akademiet-course-files/blob/main/images/auth-images/install_nuget_Swashbuckle.AspNetCore.png)

![Microsoft.Identity.Web](https://github.com/sopra-steria-norge/cloud-akademiet-course-files/blob/main/images/auth-images/install_nuget_Microsoft.Identity.Web.png)

## Use the built-in `Task list` in Visual Studio to locate the TODO's in your solution
![Task list](https://github.com/sopra-steria-norge/cloud-akademiet-course-files/blob/main/images/ef-core-migration-images/task-list.png)

## TODO: 1. Add section AzureAd to `appsettings.json`
- Add section AzureAd to `appsettings.json` and populate based on the identity we've already created --> url to app reg.

Enter the relevant application registration in the Azure Portal (Sopra Steria tenant). And copy the relevant attributes.
![App reg. with highligthed attributes]()

<details>
  <summary> Code snippet (spoiler!) </summary>
	
```csharp
"AzureAd":{
 "Instance": "https://login.microsoftonline.com/",
 "ClientId": "",
 "TenantId": ""
}
```
</details>

## TODO: 2. Add authentication middleware
- Add authentication middleware (`builder.Services.AddMicrosoftIdentityWebApiAuthentication(builder.Configuration);` `app.UseAuthentication();`)

 ## TODO: 3. Add decorators to controllers using the `[Authorize]` filter
- Add decorators to controllers using the `[Authorize]` filter

## TEST: Test the application as you did in the first step in this workshop
- Launch app try the endpoint `POST User/CreateUser` again (should now get a 401 (Unauthorized) response, i.e. the API is now protected by authentication)

 ## TODO: 4. Configure Swagger UI to use interactive authentication
- Configure Swagger UI to use interactive authentication (use builder to register Service, get values from AzureAd section in appsettings and make the app use SwaggerUI with OAuth)

## TEST: Authenticate via the padlock button in Swagger (top right)
- Launch application and authenticate using the padlock button - should now be able to log in
- Try the endpoint `POST User/CreateUser` again - should now work and give a 200 (OK) response, since you're able to get a bearer token and authenticate.

## Sources used in the course / best practice with regards to the topic Web API Authentication using MSAL in .NET

- MS authentication:
https://github.com/AzureAD/microsoft-identity-web/wiki/web-apis
 
- Use MS authentication with Swagger UI generated by Swashbuckle
https://www.josephguadagno.net/2022/06/03/enabling-user-authentication-in-swagger-using-microsoft-identity
