# Add authentication to your API (using Microsoft Authentication Library in Swagger) - HOW TO

## Starting branch
[ef-core](https://github.com/sopra-steria-norge/WhoOwesWhat-Net48/tree/ef-core)


What we are going to do in this part of the course:
- Add middleware in Program.cs (using Swashbuckle and config to set up Swagger)
- Add configuration & variables for identity in appsettings.json
- Decoration on controllers using the `[Authorize]` filter
- Application registration in Azure (we have already created this --> URL)

## Before we start doing changes, make sure that your WhoOwesWhat solution is built successfully and that the API returns 200 (OK)
- Build solution (F6) and launch app (F5)
- Try the endpoint `POST User/CreateUser` with some mock data of your choosing, should get a 200 (OK) response (since we're currently using an unprotected API)
- Make sure the `person-guid` is unique in the CreateUser request

![200 response](https://github.com/sopra-steria-norge/cloud-akademiet-course-files/blob/main/images/auth-images/200_ok_response_CreateUser.png)

## Use the built-in `Task list` in Visual Studio to locate the TODO's in your solution

![Task list](https://github.com/sopra-steria-norge/cloud-akademiet-course-files/blob/main/images/ef-core-migration-images/task-list.png)

## TODO: 1. Finish UserCredential Entity

##  Steps
- Build solution and launch app
- Try Sync endpoint, should get 200 OK (since we're using an unprotected API)
- Add Nuget packages with `CLI` or `Package Manager` (Swashbuckle.AspNetCore (probably in your project already), Microsoft.Identity.Web)
- Add section AzureAd to `appsettings.json` and populate based on the identity we've already created --> url to app reg.
- Add authentication middleware (`builder.Services.AddMicrosoftIdentityWebApiAuthentication(builder.Configuration);` `app.UseAuthentication();`)
- Add decorators to controllers using the `[Authorize]` filter
- Launch app try Sync endpoint again (should get 401 Unauthorized, the API is now protected by authentication)
- Configure Swagger UI to use interactive authentication (use builder to register Service, get values from AzureAd section in appsettings and make the app use SwaggerUI with OAuth)
- Launch application and authenticate using the padlock button - should now be able to log in
- Try Sync endpoint - should now work (200OK) since you're able to get a bearer token and authenticate


## Sources used in the course / best practice with regards to the topic Web API Authentication using MSAL in .NET

- MS authentication:
https://github.com/AzureAD/microsoft-identity-web/wiki/web-apis
 
- Use MS authentication with Swagger UI generated by Swashbuckle
https://www.josephguadagno.net/2022/06/03/enabling-user-authentication-in-swagger-using-microsoft-identity
